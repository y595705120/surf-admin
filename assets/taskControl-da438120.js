import{h as v,N as I,r as q,q as l,o as c,k as N,p as n,P as o,m as f,W as u,O as k,a5 as _,V as S}from"./vue-5a2488fc.js";import{s as V,_ as B}from"./index-a237e875.js";import{e as P,f as Z,h as D}from"./dataexport-6312c5c7.js";const A={class:"default-main"},E={style:{display:"flex","align-items":"center"}},O=v({name:"routine/dataexport/taskControl",__name:"taskControl",setup(R){const g=I(),t=q({task:{},subTask:[],requestIdx:0}),p=()=>{let s=[];for(const e in t.subTask[t.requestIdx])b(t.subTask[t.requestIdx][e].id,1),s.push(V({url:Z(t.task.id,t.subTask[t.requestIdx][e].id),method:"get"}).then(r=>{b(r.data.subId,2),t.task.lastprogress+=t.task.subtask_progress}));s.length?Promise.all(s).then(e=>{s=[],t.requestIdx++,p()}):t.task.lastprogress=100},b=(s,e)=>{for(const r in t.task.subtask)if(t.task.subtask[r].id==s){t.task.subtask[r].status=e,t.task.subtask[r].status_text=m(e);break}};P(g.params.id).then(s=>{t.task=s.data.task,t.subTask=s.data.subtaskPage;for(const e in t.task.subtask)t.task.subtask[e].status_text=m(t.task.subtask[e].status);p()});const x=()=>{D(t.task.id).then(s=>{window.location.href=s.data.url})},y=[{color:"#909399",percentage:20},{color:"#a0cfff",percentage:40},{color:"#409eff",percentage:60},{color:"#95d475",percentage:80},{color:"#67c23a",percentage:100}],m=s=>{let e="";switch(s){case 0:e="准备好";break;case 1:e="进行中";break;case 2:e="完成";break;case 3:e="失败";break}return e};return(s,e)=>{const r=l("el-alert"),i=l("el-table-column"),d=l("el-tag"),h=l("el-table"),w=l("el-progress"),T=l("el-button"),C=l("el-result");return c(),N("div",A,[n(r,{title:"《"+(t.task.name??"")+"》正在执行中，请勿刷新浏览器或关闭标签页...",type:"error",closable:!1,effect:"dark",class:"mb20"},null,8,["title"]),n(h,{data:t.task.subtask,border:"",style:{width:"100%"}},{default:o(()=>[n(i,{prop:"id",label:"序号",align:"center",width:"60"}),n(i,{label:"任务标题"},{default:o(a=>[f("div",E,"第 "+u(a.row.min)+" 到 "+u(a.row.min+a.row.max)+" 行数据",1)]),_:1}),n(i,{prop:"status_text",align:"center",label:"状态",width:"100"},{default:o(a=>[f("div",null,[a.row.status==0?(c(),k(d,{key:0,type:"info"},{default:o(()=>[_(u(a.row.status_text),1)]),_:2},1024)):a.row.status==1?(c(),k(d,{key:1},{default:o(()=>[_(u(a.row.status_text),1)]),_:2},1024)):a.row.status==2?(c(),k(d,{key:2,type:"success"},{default:o(()=>[_(u(a.row.status_text),1)]),_:2},1024)):(c(),k(d,{key:3,type:"danger"},{default:o(()=>[_(u(a.row.status_text),1)]),_:2},1024))])]),_:1})]),_:1},8,["data"]),n(w,{class:"task-progress",color:y,"stroke-width":16,percentage:t.task.lastprogress,"text-inside":!0},null,8,["percentage"]),Number(t.task.lastprogress)>=100?(c(),k(C,{key:0,icon:"success",title:"数据已备好","sub-title":"点击下载导出的数据包文件"},{extra:o(()=>[n(T,{onClick:x,type:"primary"},{default:o(()=>[_("下载ZIP")]),_:1})]),_:1})):S("",!0)])}}});const z=B(O,[["__scopeId","data-v-cb96b0c7"]]);export{z as default};
